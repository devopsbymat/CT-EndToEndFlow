---
- hosts: "masters"
  gather_facts: yes
  vars:
   - master_private_ip: 10.128.0.29
   - cidr_range: 192.168.0.0/16
    
  tasks:
     - name: initialize k8s cluster on master server 
       become: yes
       shell: sudo kubeadm init --apiserver-advertise-address={{ master_private_ip }} --pod-network-cidr={{ cidr_range }} --ignore-preflight-errors=NumCPU
    
     - name: copy admin.conf to home kube directory and get cluster-info
       shell: |
               sudo mkdir -p $HOME/.kube
               sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
               sudo chown $(id -u):$(id -g) $HOME/.kube/config

     - name: install the network plugin
       shell: kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

     - name: Get the token for joining the worker nodes
       become: yes
       shell: kubeadm token create  --print-join-command
       register: kubernetes_join_command

     - debug: var=kubernetes_join_command.stdout_lines

     - name: Copy join command to local file.
       become: yes
       local_action: copy content={{ kubernetes_join_command.stdout_lines[0] }} dest="/tmp/kubernetes_join_command" mode=0777